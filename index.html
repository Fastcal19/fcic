<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Employee Leave Page</title>
<style>
body { font-family: Arial, sans-serif; margin:5px; min-height:100vh; background:linear-gradient(10deg, gold, orangered);}
.cards { display:flex; gap:10px; margin-bottom:25px; flex-wrap:nowrap;}
.card { flex:1 1 0; min-width:0; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center;}
.card h2{margin:0 0 10px 0;font-size:16px;color:#555;}
.card .value{font-size:28px;font-weight:bold;}
button{padding:10px 20px;margin-bottom:10px;cursor:pointer;border:none;border-radius:6px;background:#007bff;color:white;font-size:14px;}
table{width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
th, td{border:1px solid #ccc;padding:10px;font-size:14px;vertical-align:middle;}
th{background:#e9ecef;text-align:left;}
.t-left{text-align:left;}
.t-center{text-align:center;}
.modal-bg{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;}
.modal{background:white; padding:20px; border-radius:10px; width:320px; box-shadow:0 2px 6px rgba(0,0,0,0.3);}
.modal h3{margin-top:0;}
.modal input, .modal select, .modal textarea{width:100%; margin-bottom:10px; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;}
.modal .actions{display:flex; gap:8px; justify-content:flex-end;}
.close-btn{background:#dc3545; color:#fff;}
input[readonly]{background:#f0f0f0;}
#toast{position:fixed; right:20px; bottom:20px; padding:12px 16px; border-radius:6px; color:white; display:none; z-index:2000; font-weight:600;}
#toast.success{background:#2e8b57;}
#toast.error{background:#c0392b;}
@media(max-width:480px){.cards{gap:8px}.card{padding:12px;}}
@media(max-width:480px) and (orientation:portrait){
  table th:nth-child(3),table th:nth-child(4),table th:nth-child(5),
  table td:nth-child(3),table td:nth-child(4),table td:nth-child(5){display:none;}
}
@media(max-width:480px) and (orientation:landscape){
  table th, table td{display:table-cell;}
}
</style>
</head>
<body>

<div class="cards">
  <div class="card"><h2>Credits</h2><div class="value" id="totalCredits">10</div></div>
  <div class="card"><h2>Used</h2><div class="value" id="leaveApplied">0</div></div>
  <div class="card"><h2>Remaining</h2><div class="value" id="remainingLeave">10</div></div>
</div>

<button onclick="openModal()">Apply</button>

<table>
  <thead>
    <tr>
      <th class="t-center">Date Filed</th>
      <th class="t-left">Reason</th>
      <th class="t-center">From</th>
      <th class="t-center">To</th>
      <th class="t-center"># of Days</th>
      <th class="t-center">Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>Apply</h3>
    <input type="text" id="eid" readonly>
    <input type="text" id="name" readonly>
    <input type="text" id="dateFiled" placeholder="Date Filed" readonly>
    <textarea id="reason" placeholder="Reason"></textarea>
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <input type="number" id="days" min="1">
    <select id="status"><option>Pending</option><option>Cancel</option></select>
    <div class="actions">
      <button class="close-btn" onclick="closeModal()">Close</button>
      <button id="submitBtn" onclick="submitLeave()" disabled>Submit</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API_BASE="https://script.google.com/macros/s/AKfycbwEKRrPzOzPlNHHlFP5kSIQ3hSJrFy9kbkHPuWZbxisvfDdutQc5IttUuQ6wP2DK-30/exec";

let applicantName = localStorage.getItem('full');
let applicantEID = localStorage.getItem('eid');
if(!applicantName){ applicantName = prompt("Enter your name:"); if(applicantName) localStorage.setItem('full', applicantName); }
if(!applicantEID){ applicantEID = prompt("Enter your Employee ID:"); if(applicantEID) localStorage.setItem('eid', applicantEID); }

const modalBg = document.getElementById('modalBg');
const dateFiled = document.getElementById('dateFiled');
const submitBtn = document.getElementById('submitBtn');
const requiredIds = ['dateFiled','reason','fromDate','toDate','days'];

function pad(n){return String(n).padStart(2,'0');}
function formatDateOnly(value){ const d = new Date(value); return isNaN(d)?value:pad(d.getMonth()+1)+'/'+pad(d.getDate())+'/'+d.getFullYear(); }
function formatDateTime(value){ const d=new Date(value); if(isNaN(d)) return value; let h=d.getHours(), ampm=h>=12?'PM':'AM'; h=h%12||12; return pad(d.getMonth()+1)+'/'+pad(d.getDate())+'/'+d.getFullYear()+' '+pad(h)+':'+pad(d.getMinutes())+' '+ampm; }
function isMobileView(){ return window.innerWidth<=480; }
function formatShortDateMobile(val){ if(!isMobileView()) return val; const d=new Date(val); if(isNaN(d)) return val; return pad(d.getMonth()+1)+'-'+pad(d.getDate())+'-'+String(d.getFullYear()).slice(-2); }

function openModal(){
  document.getElementById('eid').value=applicantEID||"";
  document.getElementById('name').value=applicantName||"";
  dateFiled.value = formatDateTime(new Date());
  ['reason','fromDate','toDate','days'].forEach(id=>document.getElementById(id).value="");
  document.getElementById('status').value="Pending";
  refreshSaveState();
  modalBg.style.display='flex';
}

function closeModal(){ modalBg.style.display='none'; }
function validateForm(){ return requiredIds.every(id=>document.getElementById(id).value.trim()!==""); }
function refreshSaveState(){ submitBtn.disabled = !validateForm(); }
requiredIds.forEach(id=>document.getElementById(id)?.addEventListener('input', refreshSaveState));

async function loadLeaves(){
  const tbody=document.querySelector('tbody');
  tbody.innerHTML=`<tr><td colspan="6">Loading...</td></tr>`;
  try{
    const res=await fetch(API_BASE+"?action=getLeaves");
    const data=await res.json();
    if(!Array.isArray(data)||data.length===0){tbody.innerHTML=`<tr><td colspan="6">No leave records found</td></tr>`; document.getElementById("leaveApplied").textContent=0; document.getElementById("remainingLeave").textContent=document.getElementById("totalCredits").textContent||"0"; return;}
    const myEID=(localStorage.getItem("eid")||"").trim().replace(/^0+/,"");
    const myLeaves=data.filter(r=>((r["EID"]||"").trim().replace(/^0+/,""))===myEID);

    const approvedLeaves=myLeaves.filter(r=>String(r["Status"]||"").toLowerCase()==="approved");
    const usedDays=approvedLeaves.reduce((sum,r)=>sum+(parseFloat(r["# of Days"]||0)||0),0);
    const totalCredits=parseFloat(document.getElementById("totalCredits").textContent)||0;
    const remaining=Math.max(0,totalCredits-usedDays);
    document.getElementById("leaveApplied").textContent=usedDays;
    document.getElementById("remainingLeave").textContent=remaining;

    tbody.innerHTML=myLeaves.map(r=>{
      const st=String(r["Status"]||"").toLowerCase();
      const color= st==="approved"?"green":st==="disapproved"?"red":st==="pending"?"blue":st==="cancelled"?"orange":"black";
      const days=r["# of Days"]||"";
      const dateFiledFormatted=isMobileView()?formatShortDateMobile(r["Date Filed"]):formatDateTime(r["Date Filed"]);
      const fromFormatted=formatDateOnly(r["From"]);
      const toFormatted=formatDateOnly(r["To"]);
      return `<tr>
        <td class="t-center">${dateFiledFormatted}</td>
        <td class="t-left">${r["Reason"]||""}</td>
        <td class="t-center">${fromFormatted}</td>
        <td class="t-center">${toFormatted}</td>
        <td class="t-center">${days}</td>
        <td class="t-center"><span style="color:${color}; font-weight:700">${r["Status"]||""}</span></td>
      </tr>`;
    }).join("");
  }catch(err){ console.error(err); tbody.innerHTML=`<tr><td colspan="6">Error loading data</td></tr>`; }
}

async function submitLeave(){
  if(!validateForm()) return;
  submitBtn.disabled=true;
  submitBtn.textContent="Submitting...";
  const payload={
    method:"submitLeave",
    eid:localStorage.getItem('eid'),
    name:localStorage.getItem('full'),
    dateFiled:document.getElementById('dateFiled').value,
    reason:document.getElementById('reason').value,
    fromDate:document.getElementById('fromDate').value,
    toDate:document.getElementById('toDate').value,
    days:document.getElementById('days').value,
    status:document.getElementById('status').value
  };
  try{
    const body='payload='+encodeURIComponent(JSON.stringify(payload));
    const res=await fetch(API_BASE,{method:"POST", headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body});
    const text=await res.text();
    let data; try{data=JSON.parse(text);}catch(err){data={status:"error",message:"Invalid JSON response"};}
    if(res.ok&&(data.status==="success"||data.success)){ showToast("Leave submitted","success"); closeModal(); await loadLeaves(); }
    else{ showToast("Failed: "+(data.message||"Unknown error"),"error"); }
  }catch(err){ console.error(err); showToast("Network error","error");}
  finally{ submitBtn.textContent="Submit"; refreshSaveState(); }
}

function showToast(msg,type){ const t=document.getElementById('toast'); t.textContent=msg; t.className=type; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }

loadLeaves();
</script>
</body>
</html>
