<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Employee Leave Page</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 5px;                        
  min-height: 100vh;                 
  background: linear-gradient(10deg, gold, orangered);
}

/* Cards */
.cards {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  flex-wrap: nowrap;
}

.card {
  flex: 1 1 0;
  min-width: 0;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-align: center;
}

.card h2 { margin:0 0 10px 0; font-size:16px; color:#555; }
.card .value { font-size:28px; font-weight:bold; }

button {
  padding:10px 20px; margin-bottom:10px; cursor:pointer;
  border:none; border-radius:6px; background:#007bff; color:white;
  font-size:14px;
}

table {
  width:100%; border-collapse:collapse; background:white;
  border-radius:10px; overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
th, td { border:1px solid #ccc; padding:10px; font-size:14px; }
th { background:#e9ecef; text-align:left; }

/* Modal */
.modal-bg {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
  z-index: 999;
}
.modal {
  background:white; padding:20px; border-radius:10px; width:320px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.modal h3 { margin-top:0; }
.modal input, .modal select, .modal textarea {
  width:100%; margin-bottom:10px; padding:8px; font-size:14px;
  border:1px solid #ccc; border-radius:5px;
  box-sizing: border-box;
}
.modal .actions { text-align:right; display:flex; gap:8px; justify-content:flex-end; }
.close-btn { background:#dc3545; color:#fff; }
input[readonly] { background:#f0f0f0; }

/* Toast */
#toast {
  position: fixed;
  right: 20px;
  bottom: 20px;
  padding: 12px 16px;
  border-radius: 6px;
  color: white;
  display: none;
  z-index: 2000;
  font-weight: 600;
}
#toast.success { background: #2e8b57; }
#toast.error { background: #c0392b; }

/* Responsive */
@media (max-width:480px){.cards{gap:8px}.card{padding:12px}}
@media (max-width:480px) and (orientation:portrait){
  table th:nth-child(3),table th:nth-child(4),table th:nth-child(5),
  table td:nth-child(3),table td:nth-child(4),table td:nth-child(5){display:none;}
}
@media (max-width:480px) and (orientation:landscape){
  table th,table td{display:table-cell;}
}
</style>
</head>
<body>

<div class="cards">
  <div class="card"><h2>Credits</h2><div class="value" id="totalCredits">10</div></div>
  <div class="card"><h2>Used</h2><div class="value" id="leaveApplied">0</div></div>
  <div class="card"><h2>Remaining</h2><div class="value" id="remainingLeave">10</div></div>
</div>

<button onclick="openModal()">Apply</button>

<table>
  <thead><tr>
    <th>Date Filed</th><th>Reason</th><th>From</th><th>To</th><th># of Days</th><th>Status</th>
  </tr></thead>
  <tbody></tbody>
</table>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>Apply Leave</h3>
    <input type="text" id="eid" readonly>
    <input type="text" id="name" readonly>

    <!-- TIMESTAMP FIELD READONLY -->
    <input type="text" id="dateFiled" placeholder="Date Filed" readonly>

    <textarea id="reason" placeholder="Reason"></textarea>
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <input type="number" id="days" min="1">
    <select id="status"><option>Pending</option><option>Cancel</option></select>
    <div class="actions">
      <button class="close-btn" onclick="closeModal()">Close</button>
      <button id="submitBtn" onclick="submitLeave()" disabled>Submit</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API_BASE="https://script.google.com/macros/s/AKfycbwItQon1Z-VC_pCyRnFsrWHuwqU1XMPl5Kp4_otZYPFWSkVkfhiJ6hnqf-Cg_qyyzy5/exec";

let applicantName=localStorage.getItem('full');
let applicantEID=localStorage.getItem('eid');
if(!applicantName){applicantName=prompt("Enter your name:");if(applicantName) localStorage.setItem('full',applicantName);}
if(!applicantEID){applicantEID=prompt("Enter your Employee ID:");if(applicantEID) localStorage.setItem('eid',applicantEID);}

const modalBg=document.getElementById('modalBg');
const dateFiled=document.getElementById('dateFiled');
const submitBtn=document.getElementById('submitBtn');
const requiredIds=['dateFiled','reason','fromDate','toDate','days'];

function formatTimestamp(){
  const now=new Date();
  return now.getFullYear()+"-"+
    String(now.getMonth()+1).padStart(2,"0")+"-"+
    String(now.getDate()).padStart(2,"0")+" "+
    String(now.getHours()).padStart(2,"0")+":"+
    String(now.getMinutes()).padStart(2,"0")+":"+
    String(now.getSeconds()).padStart(2,"0");
}

function openModal(){
  document.getElementById('eid').value=applicantEID||"";
  document.getElementById('name').value=applicantName||"";
  dateFiled.value=formatTimestamp();
  ['reason','fromDate','toDate','days'].forEach(id=>document.getElementById(id).value="");
  document.getElementById('status').value="Pending";
  refreshSaveState();
  modalBg.style.display='flex';
}

function closeModal(){modalBg.style.display='none';}

function validateForm(){return requiredIds.every(id=>document.getElementById(id).value.trim()!=="");}
function refreshSaveState(){submitBtn.disabled=!validateForm();}
requiredIds.forEach(id=>document.getElementById(id)?.addEventListener('input',refreshSaveState));

async function submitLeave(){
  if(!validateForm()) return;
  submitBtn.disabled=true;
  submitBtn.textContent="Submitting...";

  // read values using getElementById (avoid using undeclared identifiers)
  const payload = {
    method: "submitLeave",
    eid: localStorage.getItem('eid'),
    name: localStorage.getItem('full'),
    dateFiled: document.getElementById('dateFiled').value,
    reason: document.getElementById('reason').value,
    fromDate: document.getElementById('fromDate').value,
    toDate: document.getElementById('toDate').value,
    days: document.getElementById('days').value,
    status: document.getElementById('status').value
  };

  try {
    // Send as form-encoded to avoid CORS preflight (application/x-www-form-urlencoded)
    const body = 'payload=' + encodeURIComponent(JSON.stringify(payload));

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });

    // response will be JSON text if server returns JSON
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch (err) { data = { status: "error", message: "Invalid JSON response" }; }

    if (res.ok && (data.status === "success" || data.success)) {
      showToast("Leave submitted", "success");
      closeModal();
      loadLeaves();
    } else {
      showToast("Failed: " + (data.message || "Unknown error"), "error");
    }
  } catch (err) {
    console.error("submit error:", err);
    showToast("Network error", "error");
  } finally {
    submitBtn.textContent = "Submit";
    refreshSaveState();
  }
}

function showToast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className=type;t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
function loadLeaves(){} // unchanged partâ€¦

loadLeaves();
</script>
</body>
</html>
