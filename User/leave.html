<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Employee Leave Page</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 5px;                        
  min-height: 100vh;                 
  background: linear-gradient(10deg, gold, orangered);
}

/* Cards */
.cards {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  flex-wrap: nowrap; /* keep in one row */
}

.card {
  flex: 1 1 0;          /* allow proportional shrinking */
  min-width: 0;         /* ensures shrinking works */
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-align: center;
}

.card h2 { margin:0 0 10px 0; font-size:16px; color:#555; }
.card .value { font-size:28px; font-weight:bold; }

button {
  padding:10px 20px; margin-bottom:10px; cursor:pointer;
  border:none; border-radius:6px; background:#007bff; color:white;
  font-size:14px;
}

table {
  width:100%; border-collapse:collapse; background:white;
  border-radius:10px; overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
th, td { border:1px solid #ccc; padding:10px; font-size:14px; }
th { background:#e9ecef; text-align:left; }

/* Popup Modal */
.modal-bg {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
  z-index: 999;
}
.modal {
  background:white; padding:20px; border-radius:10px; width:320px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.modal h3 { margin-top:0; }
.modal input, .modal select, .modal textarea {
  width:100%; margin-bottom:10px; padding:8px; font-size:14px;
  border:1px solid #ccc; border-radius:5px;
  box-sizing: border-box;
}
.modal .actions { text-align:right; display:flex; gap:8px; justify-content:flex-end; }
.close-btn {
  background:#dc3545;
  color: #fff;
}
input[readonly] { background:#f0f0f0; }

/* Toast */
#toast {
  position: fixed;
  right: 20px;
  bottom: 20px;
  padding: 12px 16px;
  border-radius: 6px;
  color: white;
  display: none;
  z-index: 2000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: 600;
}
#toast.success { background: #2e8b57; }
#toast.error { background: #c0392b; }

/* ===== RESPONSIVE ===== */

/* Cards shrink proportionally on small screens */
@media (max-width: 480px) {
  .cards { gap: 8px; }
  .card { padding: 12px; }
}

/* Table column visibility */
/* Portrait: only show 1st, 2nd, 6th */
@media (max-width: 480px) and (orientation: portrait) {
  table th:nth-child(3),
  table th:nth-child(4),
  table th:nth-child(5),
  table td:nth-child(3),
  table td:nth-child(4),
  table td:nth-child(5) {
    display: none;
  }
}

/* Landscape: show all columns */
@media (max-width: 480px) and (orientation: landscape) {
  table th, table td { display: table-cell; }
}

</style>
</head>
<body>

<!-- Cards -->
<div class="cards">
  <div class="card"><h2>Credits</h2><div class="value" id="totalCredits">10</div></div>
  <div class="card"><h2> Used</h2><div class="value" id="leaveApplied">0</div></div>
  <div class="card"><h2>Remaining</h2><div class="value" id="remainingLeave">10</div></div>
</div>

<button onclick="openModal()">Apply</button>

<table>
  <thead>
    <tr>
      <th>Date Filed</th>
      <th>Reason</th>
      <th>From</th>
      <th>To</th>
      <th># of Days</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal-bg" id="modalBg">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Apply Leave</h3>
    <input type="text" id="eid" placeholder="Employee ID" readonly>
    <input type="text" id="name" placeholder="Name" readonly>
    <input type="date" id="dateFiled" placeholder="Date Filed">
    <textarea id="reason" placeholder="Reason"></textarea>
    <input type="date" id="fromDate" placeholder="From">
    <input type="date" id="toDate" placeholder="To">
    <input type="number" id="days" placeholder="# of Days" min="1">
    <select id="status">
      <option>Pending</option>
      <option>Cancel</option>
    </select>
    <div class="actions">
      <button class="close-btn" onclick="closeModal()" type="button">Close</button>
      <button id="saveBtn" onclick="saveLeave()" disabled type="button">Save</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbxoxV6KABguvPj9nuVr28CfG57gyDnUUtcdQRYnS5dXvu7vwfeDxL_6-5Nhwt1pvShs/exec";

let applicantName = localStorage.getItem('full');
let applicantEID  = localStorage.getItem('eid');
if(!applicantName){ applicantName = prompt("Enter your name:"); if(applicantName) localStorage.setItem('full', applicantName);}
if(!applicantEID){ applicantEID = prompt("Enter your Employee ID:"); if(applicantEID) localStorage.setItem('eid', applicantEID);}

const modalBg = document.getElementById('modalBg');
const eidInput = document.getElementById('eid');
const nameInput = document.getElementById('name');
const dateFiled = document.getElementById('dateFiled');
const reason = document.getElementById('reason');
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
const days = document.getElementById('days');
const status = document.getElementById('status');
const saveBtn = document.getElementById('saveBtn');
const toastEl = document.getElementById('toast');
const requiredIds = ['dateFiled','reason','fromDate','toDate','days'];

function showToast(message, type='success'){
  toastEl.textContent = message;
  toastEl.className='';
  toastEl.classList.add(type==='success'?'success':'error');
  toastEl.style.display='block';
  setTimeout(()=>{toastEl.style.display='none';},3000);
}

function validateForm(){ return requiredIds.every(id=>{ const el=document.getElementById(id); return el && String(el.value).trim()!=="";});}
function refreshSaveState(){ saveBtn.disabled = !validateForm();}
requiredIds.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', refreshSaveState); el.addEventListener('change', refreshSaveState); }});

function openModal(){
  eidInput.value = applicantEID || "";
  nameInput.value = applicantName || "";
  dateFiled.value = "";
  reason.value = "";
  fromDate.value = "";
  toDate.value = "";
  days.value = "";
  status.value = "Pending";
  refreshSaveState();
  modalBg.style.display='flex';
  dateFiled.focus();
}

function closeModal(){ modalBg.style.display='none'; }

async function loadLeaves(){
  try{
    const res = await fetch(`${API_BASE}?action=getLeaves`);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } 
    catch { showToast("Server returned invalid data.", "error"); return; }

    const tbody = document.querySelector("table tbody");
    tbody.innerHTML="";

    let totalCredits = 10, leaveApplied = 0;

    if(Array.isArray(data)){
      data.forEach(row => {
        if(String(row.EID) === String(applicantEID) && String(row.Status).toLowerCase() === "approved"){
          const daysVal = Number(row['# of Days'] || row.days || 0);
          if(!isNaN(daysVal)) leaveApplied += daysVal;

          tbody.innerHTML += `<tr>
            <td>${escapeHtml(row['Date Filed'] || row.dateFiled || '')}</td>
            <td>${escapeHtml(row['Reason'] || row.reason || '')}</td>
            <td>${escapeHtml(row['From'] || row.fromDate || '')}</td>
            <td>${escapeHtml(row['To'] || row.toDate || '')}</td>
            <td>${escapeHtml(row['# of Days'] || row.days || '')}</td>
            <td>${escapeHtml(row['Status'] || row.status || '')}</td>
          </tr>`;
        }
      });
    }

    document.getElementById('totalCredits').textContent = totalCredits;
    document.getElementById('leaveApplied').textContent = leaveApplied;
    document.getElementById('remainingLeave').textContent = totalCredits - leaveApplied;

  }catch{
    showToast("Could not load leaves (network).","error");
  }
}

async function saveLeave(){
  if(!validateForm()){ showToast("Please complete all required fields.","error"); return; }
  saveBtn.disabled=true;
  saveBtn.textContent="Saving...";

  const payload={ method:"saveLeave", EID:applicantEID, name:applicantName,
    dateFiled:dateFiled.value, reason:reason.value, fromDate:fromDate.value,
    toDate:toDate.value, days:days.value, status:status.value };

  try{
    const res = await fetch(API_BASE,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(payload) });
    const txt = await res.text();
    let data;
    try{ data=JSON.parse(txt);}catch{ data={ error:'Invalid server response'};}
    if(res.ok && (data.status==="success"||data.success===true)){ showToast("Leave saved successfully!","success"); closeModal(); await loadLeaves(); }
    else{ const errMsg = data.message||data.error||"Failed to save leave."; showToast(errMsg,"error"); }
  }catch{ showToast("Network error while saving.","error"); }
  finally{ saveBtn.disabled = !validateForm(); saveBtn.textContent="Save"; }
}

function escapeHtml(str){ if(str===null||str===undefined) return ''; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

loadLeaves();
window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
</script>

</body>
</html>
