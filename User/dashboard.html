<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display:flex; height:100vh; }
    .main{ flex:1; background:#e6e7ea; padding:20px; overflow:hidden; display:flex; flex-direction:column;}
  
    .calendar-container{ flex:1; display:flex; flex-direction:column; overflow:hidden;}
    .calendar{ flex:1; background:#fb923c; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); padding:15px; display:flex; flex-direction:column; overflow:hidden;}
    .calendar-header{ display:flex; justify-content:center; align-items:center; margin-bottom:4px; gap:10px;}
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: auto repeat(6, 1fr);
      flex: 1;
      gap: 5px;
      height: 100%;
    }
    .day-name {
      font-weight: bold;
      text-align: center;
      background: #FFC107;
      border-radius: 6px;
      display: flex;
      padding: 10px;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
    }
    .day{ padding:5px; border-radius:5px; cursor:pointer; background:#f5deb3; position:relative; overflow:hidden; display:flex; flex-direction:column;}
    .day * {pointer-events: none; /* ðŸ”’ prevent inner elements from blocking click */}
    .day{cursor:default;}
    .day.has-note { cursor: hand; /* show pointer only when a note exists */}
    .day.has-note:hover {  background: #deb887; /* soft orange highlight on hover */
}
    .day-number{ font-size:0.85em; font-weight:bold; color:darkred; position:absolute; top:5px; right:6px;}
    .today{ background:linear-gradient(135deg, #FFA500, #FFD700); font-weight:bold; box-shadow:0 0 6px rgba(0,0,0,0.4);}
    .note{ font-size:0.7em; margin-top:18px; color:darkgreen; text-align:left; word-break:break-word; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;}
    .faded{ background:#eee !important; color:#999 !important; cursor:default !important; pointer-events:none;}

    /* ðŸ“± On mobile: show only the calendar, hide others */
@media (max-width: 768px) {
  body {
    display: block;
  }

  .header,
  .cards,
  .notes-columns,
  #approvalModal {
    display: none !important;
  }

  .calendar-container {
    width: 100%;
    height: 100vh;
    display: flex;
  }

  .calendar {
    width: 100%;
    height: 100%;
    border-radius: 0;
    padding: 10px;
    padding-bottom: env(safe-area-inset-bottom);

  }
}

#noteModal {
  display: none;
  position: fixed;
  inset: 0;
  width: 450px;
  height: auto;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  margin: auto;
}

#noteModal .modal-content {
  width: 100%;
  height: 100%;
  max-width: none;
  border-radius: 0;
  background: #fff;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
}

/* Header */
#noteModal h3 {
  margin: 0 0 10px 0;
  text-align: center;
  font-size: 1.2em;
  background: #f97316;
  color: white;
  padding: 10px;
  border-radius: 8px;
}

/* Text area */
#noteText {
  flex: 1;
  width: 100%;
  font-size: 1em;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  box-sizing: border-box;
  resize: none;
  outline: none;
  margin-top: 10px;
  overflow-y: auto;
}

/* Footer */
#noteModal .modal-footer {
  position: sticky;
  bottom: 0;
  background: #fff;
  padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
  display: flex;
  justify-content: space-between;
  gap: 10px;
  z-index: 2;
}

.close-btn {
  flex: 1;
  padding: 14px;
  font-size: 1em;
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
}

/* âœ… Responsive: Full-screen on mobile */
@media (max-width: 600px) {
  #noteModal {
    width: 100%;
    height: 100%;
    margin: 0;
  }

  #noteModal .modal-content {
    width: 100%;
    height: 95%;
    border-radius: 0;
    padding: 16px;
  }

  #noteModal h3 {
    font-size: 1.1em;
    border-radius: 6px;
  }

  #noteText {
    font-size: 0.95em;
  }

  .close-btn {
    padding: 12px;
    font-size: 0.95em;
  }
}


.close-btn { background: #b22222; }

/* Mobile tweaks */
@media (max-width: 768px) {
  #noteModal .modal-content {
    padding: 15px 15px calc(15px + env(safe-area-inset-bottom));
  }

  #noteModal h3 {
    font-size: 1.1em;
    padding: 8px;
  }

  .save-btn, .close-btn {
    font-size: 1.1em;
    padding: 16px;
  }
}




@media (max-width: 768px) {
  html, body {
    margin: 0;
    padding: 0;
    height: 100dvh; /* âœ… dynamic full height */
    overflow: hidden;
    background: #fb923c;
  }

  .main {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
  }

  /* Hide desktop-only sections */
  .header,
  .cards,
  .notes-columns,
  #approvalModal {
    display: none !important;
  }

  /* Main mobile view container */
  .calendar-notes {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  /* âœ… Calendar itself fills safe area */
  .calendar {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    height: calc(100dvh - env(safe-area-inset-bottom));
    border-radius: 0;
    padding: 10px;
    padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* âœ… prevents overlap */
    box-sizing: border-box;
    overflow-y: auto;
  }

  .calendar-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 5px;
    min-height: 0;
  }

  .day-name {
    font-size: 0.8em;
  }
}


  </style>
</head>
<body>
  <div class="main">
      <div class="calendar-container">
        <div class="calendar">
          <div class="calendar-header">
            <button onclick="prevMonth()">&#8592;</button>
            <h2 id="monthYear"></h2>
            <button onclick="nextMonth()">&#8594;</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div id="noteModal" class="modal">
  <div class="modal-content">
    <h3>Notes</h3>
    <h4 id="modalDate" style="text-align:center; color:#333; margin-top:-5px;"></h4>
    <textarea id="noteText" placeholder="Enter your note..."></textarea>
    <div class="modal-footer">
      <button class="close-btn">Close</button>
    </div>
  </div>
</div>

  <script>
  // <-- set your deployed Apps Script webapp URL here (must allow POST & CORS if needed) -->
  const API_URL = "https://script.google.com/macros/s/AKfycbyP6xne0iCnV0nrgYg0TnS-dE2TisBlQS4DOtSTgkOfWAQUsC7No5aNLFpAsTEc6ax5/exec";

  const calendarGrid = document.getElementById("calendarGrid");
  const monthYear = document.getElementById("monthYear");
  const noteModal = document.getElementById("noteModal");
  const modalDate = document.getElementById("modalDate");
  const noteText = document.getElementById("noteText");
  const remindersList = document.getElementById("remindersList");
  const approvalList = document.getElementById("approvalList");

  const approvalModal = document.getElementById("approvalModal");
  const approvalDetails = document.getElementById("approvalDetails");

  let currentDate = new Date();
  let selectedDate = null;
  let notes = {};
  let currentRequest = null; // full request object
  let currentRequestExtract = null; // extracted fields

  // ---------------- helpers ----------------
  function formatDateForDisplay(dateInput) {
    if (!dateInput) return "";
    // try to parse different formats robustly
    const d = new Date(dateInput);
    if (isNaN(d.getTime())) {
      // try replacing space-only formats or common variants
      const tryParse = Date.parse(String(dateInput).replace(/(\s)+/g, ' '));
      if (!isNaN(tryParse)) return new Date(tryParse).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
      return String(dateInput);
    }
    return d.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  }

  function getFirstKeyValue(obj, candidates) {
    if (!obj) return undefined;
    for (const k of candidates) if (k in obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
    const lower = {};
    for (const [k,v] of Object.entries(obj)) lower[k.toLowerCase()] = v;
    for (const k of candidates) {
      const lk = k.toLowerCase();
      if (lk in lower) return lower[lk];
    }
    return undefined;
  }
  function findByPattern(obj, regex) {
    for (const v of Object.values(obj)) {
      if (typeof v === 'string' && regex.test(v)) return v;
    }
    return undefined;
  }

  function extractRequestData(req) {
    if (!req) return {};
    const date = getFirstKeyValue(req, ['Date','date','Timestamp','timestamp','Date Filed','Created','Submitted']) ||
                 findByPattern(req, /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/) ||
                 findByPattern(req, /\d{4}-\d{1,2}-\d{1,2}/);
    const name = getFirstKeyValue(req, ['Name','name','Employee','Employee Name','EmployeeName','Full Name','FullName','Requested By','Requester']) ||
                 (() => {
                   for (const v of Object.values(req)) {
                     if (typeof v === 'string') {
                       const s = v.trim();
                       if (s.length>2 && /[a-zA-Z]/.test(s) && /\s/.test(s) &&
                           !/advance|leave|cash|php|â‚±|\d{2,4}-\d{1,2}-\d{1,2}/i.test(s)) return s;
                     }
                   }
                   return undefined;
                 })();
    const type = getFirstKeyValue(req, ['Type','type','Request Type','RequestType','Form','Form Type','Request']) ||
                 findByPattern(req, /advance|cash advance|leave|sick|vacation|overtime|ot/i);
    const purpose = getFirstKeyValue(req, ['Purpose','purpose','Remarks','Detail','Details','Purpose of Advance']) ||
                    getFirstKeyValue(req, ['Remarks','remarks','Notes']);
    const amount = getFirstKeyValue(req, ['Amount','amount','Amt','AMOUNT','Amount (PHP)']) ||
                   (() => {
                     for (const v of Object.values(req)) {
                       if (typeof v === 'string' && /^(php|â‚±)?\s?[0-9,]+(\.\d+)?$/i.test(v.trim())) return v;
                       if (typeof v === 'number') return v;
                     }
                     return undefined;
                   })();
    const reason = getFirstKeyValue(req, ['Reason','reason','Reason for Leave','Leave Reason']) || purpose;
    const dateCovered = getFirstKeyValue(req, ['Date Covered','DateCovered','Date Range','Dates','From','To','Date From - To','Covered Dates']) ||
                        getFirstKeyValue(req, ['Date From','Date To','From Date','To Date']);
    const days = getFirstKeyValue(req, ['No. of Days','No of Days','Days','Number of Days','NoDays','Days Count']) ||
                 findByPattern(req, /\b\d+\s*(day|days)\b/i) || undefined;
    const id = getFirstKeyValue(req, ['ID','Id','id','Row','row','_id','rowIndex','RowIndex']);
    return { date, name, type, purpose, amount, reason, dateCovered, days, id };
  }

  // ---------------- data loaders ----------------
  async function loadNotes() {
    try {
      const res = await fetch(API_URL + "?type=notes");
      const json = await res.json();
      notes = {};
      json.forEach(n => { notes[n.date] = n.note; });
      renderCalendar();
    } catch (err) {
      console.error("Error loading notes:", err);
    }
  }

  // short date for list: e.g., Sep 17
  function formatDateShort(d) {
    try {
      const dt = new Date(d);
      if (isNaN(dt)) return String(d).slice(0,10);
      return dt.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    } catch { return String(d).slice(0,10); }
  }

  function openApprovalModal(request) {
    currentRequest = request;
    currentRequestExtract = extractRequestData(request);
    const typeRaw = (currentRequestExtract.type || '').toString().toLowerCase();

    let html = '';

    // For both types we add editable Notes and, for Advances, editable Amount
    if (typeRaw.includes('advance') || typeRaw.includes('cash')) {
      html = `
        <div class="approval-field"><span class="approval-label">Date:</span><span class="small-muted">${formatDateForDisplay(currentRequestExtract.date || request.Date || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Name:</span><span class="small-muted">${escapeHtml(currentRequestExtract.name || request.Name || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Purpose:</span><span class="small-muted">${escapeHtml(currentRequestExtract.purpose || request.Purpose || '')}</span></div>

        <div class="approval-field">
          <label class="approval-label" for="approvalAmount">Amount</label>
          <input id="approvalAmount" type="number" step="0.01" value="${sanitizeNumber(currentRequestExtract.amount || request.Amount || '')}">
        </div>

        <div class="approval-field">
          <label class="approval-label" for="approvalNotes">Notes</label>
          <textarea id="approvalNotes">${escapeHtml(currentRequest.Notes || currentRequest.Notes === "" ? currentRequest.Notes : (request.Notes || ''))}</textarea>
        </div>
      `;
    } else if (typeRaw.includes('leave')) {
      html = `
        <div class="approval-field"><span class="approval-label">Date:</span><span class="small-muted">${formatDateForDisplay(currentRequestExtract.date || request.Date || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Name:</span><span class="small-muted">${escapeHtml(currentRequestExtract.name || request.Name || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Reason:</span><span class="small-muted">${escapeHtml(currentRequestExtract.reason || request.Reason || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Date Covered:</span><span class="small-muted">${escapeHtml(currentRequestExtract.dateCovered || request.DateCovered || '')}</span></div>
        <div class="approval-field"><span class="approval-label"># of Days:</span><span class="small-muted">${escapeHtml(currentRequestExtract.days || request.Days || '')}</span></div>

        <div class="approval-field">
          <label class="approval-label" for="approvalNotes">Notes</label>
          <textarea id="approvalNotes">${escapeHtml(currentRequest.Notes || currentRequest.Notes === "" ? currentRequest.Notes : (request.Notes || ''))}</textarea>
        </div>
      `;
    } else {
      // generic fallback with editable notes
      html = `
        <div class="approval-field"><span class="approval-label">Date:</span><span class="small-muted">${formatDateForDisplay(currentRequestExtract.date || request.Date || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Name:</span><span class="small-muted">${escapeHtml(currentRequestExtract.name || request.Name || '')}</span></div>
        <div class="approval-field"><span class="approval-label">Type:</span><span class="small-muted">${escapeHtml(currentRequestExtract.type || request.Type || '')}</span></div>
        <div class="approval-field">
          <label class="approval-label" for="approvalNotes">Notes</label>
          <textarea id="approvalNotes">${escapeHtml(currentRequest.Notes || currentRequest.Notes === "" ? currentRequest.Notes : (request.Notes || ''))}</textarea>
        </div>
      `;
    }

    approvalDetails.innerHTML = html;
    approvalModal.style.display = "flex";
  }

  function closeApprovalModal() {
    approvalModal.style.display = "none";
    currentRequest = null;
    currentRequestExtract = null;
  }

  // ---------------- Approve/Reject -> send to Apps Script ----------------
  async function handleApproval(action) {
    if (!currentRequest) return;
    try {
      // collect editable fields
      const notesEl = document.getElementById("approvalNotes");
      const amountEl = document.getElementById("approvalAmount");
      const notes = notesEl ? notesEl.value : (currentRequest.Notes || '');
      const amount = amountEl ? amountEl.value : (currentRequest.Amount || currentRequest.amount || '');

      // robust id detection
      const idVal = (currentRequestExtract && currentRequestExtract.id) ? currentRequestExtract.id :
                    (currentRequest.ID || currentRequest.Id || currentRequest.id || '');

      // Build payload as FormData (Apps Script friendly)
      const fd = new FormData();
      fd.append('action', 'updateStatus'); // custom action flag for your script
      fd.append('id', idVal);
      fd.append('status', action);
      fd.append('type', currentRequestExtract.type || currentRequest.Type || '');
      fd.append('name', currentRequestExtract.name || currentRequest.Name || '');
      fd.append('date', currentRequestExtract.date || currentRequest.Date || '');
      fd.append('notes', notes);
      if (amount !== undefined) fd.append('amount', amount);

      const res = await fetch(API_URL, { method: 'POST', body: fd });
      // some Apps Script deployments return JSON, some plain text â€” handle both
      let result;
      try { result = await res.json(); } catch (e) { result = { success: true }; }

      if (result && (result.success === true || result.ok === true || result.updated === true)) {
        // success
        closeApprovalModal();
        await loadApprovals(); // refresh
      } else {
        // if result falsey still try reload but inform user
        console.warn('Unexpected response from API:', result);
        alert('Update sent. If sheet did not change, check Apps Script logs.');
        closeApprovalModal();
        await loadApprovals();
      }
    } catch (err) {
      console.error("Error updating request:", err);
      alert("Failed to update request. Check console for details.");
    }
  }

  // ---------------- Calendar render (unchanged) ----------------
  function renderCalendar() {
    calendarGrid.innerHTML = "";
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    monthYear.textContent = currentDate.toLocaleString("default", { month: "long" }) + " " + year;

    const isMobile = window.innerWidth <= 768;
const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
dayNames.forEach(d => {
  const dn = document.createElement("div");
  dn.className = "day-name";
  dn.textContent = isMobile ? d.slice(0, 3) : d.toUpperCase(); // "Sun" or "SUNDAY"
  calendarGrid.appendChild(dn);
});



    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    for (let i = firstDay - 1; i >= 0; i--) {
      const dayDiv = document.createElement("div");
      dayDiv.className = "day faded";
      dayDiv.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
      calendarGrid.appendChild(dayDiv);
    }

    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${year}-${month+1}-${day}`;
      const savedNote = notes[dateKey] || "";
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
        dayDiv.classList.add("today");
      }
      if (notes[dateKey] && notes[dateKey].trim() !== "") {
  dayDiv.classList.add("has-note");
}

      dayDiv.innerHTML = `
        <div class="day-number">${day}</div>
        ${savedNote ? `<div class="note">${savedNote}</div>` : ""}
      `;
      // Assuming you loop through each day in your calendar
dayDiv.onclick = () => {
  const savedNote = notes[dateKey];
  if (savedNote && savedNote.trim() !== "") {
    openModal(dateKey, savedNote);
  } else {
    // Optional: small feedback for empty days
    console.log("No note for this day");
  }
};

      calendarGrid.appendChild(dayDiv);
    }

    const totalCells = firstDay + daysInMonth;
    const nextDays = 42 - totalCells;
    for (let i = 1; i <= nextDays; i++) {
      const dayDiv = document.createElement("div");
      dayDiv.className = "day faded";
      dayDiv.innerHTML = `<div class="day-number">${i}</div>`;
      calendarGrid.appendChild(dayDiv);
    }
  }

  // ---------------- Notes modal ----------------
  function openModal(dateKey, savedNote) {
    selectedDate = dateKey;
    modalDate.textContent = "Notes for " + dateKey;
    noteText.value = savedNote;
    noteModal.style.display = "flex";
  }
  function closeModal() { noteModal.style.display = "none"; }

  
  function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); loadReminders(); }
  function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); loadReminders(); }

  // ---------------- util ----------------
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }
  function sanitizeNumber(v) {
    if (v === undefined || v === null) return '';
    return String(v).replace(/[^0-9.\-]/g,'');
  }

  // ---------------- initial load ----------------
  loadNotes();
  

  // --- Preserve URL parameters (like ?id=123) across reloads ---
(function preserveParams() {
  const params = new URLSearchParams(window.location.search);
  if (params.toString()) {
    // Store params temporarily in sessionStorage
    sessionStorage.setItem("savedParams", params.toString());
  } else {
    // Restore if missing
    const saved = sessionStorage.getItem("savedParams");
    if (saved) {
      const newUrl = window.location.pathname + "?" + saved;
      window.history.replaceState({}, "", newUrl);
    }
  }
})();

// Attach event listeners for Note Modal buttons
document.querySelector("#noteModal .close-btn").addEventListener("click", closeModal);

  </script>
</body>
</html>
