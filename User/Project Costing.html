<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Costing</title>
  <style>
    html,body { height:100%; margin:0; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
      overflow:auto;
    }
    #bgCanvas {
      position: fixed;
      left: 0; top: 0; width: 100%; height: 100%;
      z-index: 0; pointer-events: none;
    }
    .page { position: relative; z-index: 2; padding: 20px; }
    h2 { margin: 0 0 12px 0; color:#2c3e50; }

    /* Filters */
    .filters {
      margin-bottom:12px; display:flex; gap:8px;
      flex-wrap:wrap; align-items:center;
    }
    .filters select, .filters button {
      padding:6px 10px; border-radius:6px; border:1px solid #ccc;
      background:#fff; cursor:pointer;
    }
    .filters label { font-size:14px; color:#333; display:flex; gap:6px; align-items:center; }
    #spinner-pc {
      display:none; width:42px; height:42px;
      border:6px solid #f3f3f3; border-top:6px solid #3498db;
      border-radius:50%; animation:spin 1s linear infinite; margin-left:8px;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Table */
    table { width:100%; background:orange;
      margin-top:8px; box-shadow:0 6px 18px rgba(0,0,0,0.15);
      border-radius:6px; overflow:hidden;
    }
    thead th {
      background:#4a4a4a; color:#fff; padding:10px;
      text-align:center; font-weight:600; border-bottom:2px solid #333;
    }
    th, td { padding:8px 10px; border-bottom:1px solid #eee; word-wrap:break-word; text-align:left; }
    #pcTable tbody tr:nth-child(odd) { background: #f9f9f9; }
    #pcTable tbody tr:nth-child(even){ background: #ffffff; }
    #pcTable tbody tr:hover { background: orange; cursor: pointer; transition: background-color 0.25s; }

    /* Column widths */
    #pcTable th:nth-child(1), #pcTable td:nth-child(1) { width: 10%; }
    #pcTable th:nth-child(2), #pcTable td:nth-child(2) { width: 25%; }
    #pcTable th:nth-child(3), #pcTable td:nth-child(3) { width: 15%; }
    #pcTable th:nth-child(4), #pcTable td:nth-child(4) { width: 40%; }
    #pcTable th:nth-child(5), #pcTable td:nth-child(5) { width: 10%; }

    .empty-msg { color:#777; text-align:center; padding:12px; }

    /* Modal (shared) */
    .modal {
      display:none; position:fixed; z-index:1001;
      left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .modal-content {
      background:#fff; margin:6% auto; padding:0; border-radius:10px;
      max-width:900px; width:90%; height:80%;
      position:relative; box-shadow:0 16px 48px rgba(0,0,0,0.4);
      overflow:hidden; display:flex; flex-direction:column;
    }
    .modal iframe {
      width:100%; height:100%; border:none;
      background:#fff; border-radius:10px;
    }
    .close-btn {
      position:absolute; top:10px; right:15px;
      font-size:22px; color:#fff; cursor:pointer; z-index:10;
    }

/* Table row striping */
#pcTable tbody tr:nth-child(odd) { 
  background: #fff3e0; /* light orange tint */
}
#pcTable tbody tr:nth-child(even) { 
  background: #ffe0b2; /* slightly darker orange */
}

/* Hover highlight */
#pcTable tbody tr:hover { 
  background: #ffb74d; 
  cursor: pointer;
  transition: background-color 0.25s;
}


    @media (max-width:640px) {
      .filters { gap:6px; }
      #pcTable th, #pcTable td { font-size:13px; padding:6px 8px; }
    }
  </style>
</head>
<body>

<canvas id="bgCanvas" aria-hidden="true"></canvas>

<div class="page">
  <h2>ðŸ“Š Project Costing</h2>

  <div class="filters">
    <label>Project / Description:
      <select id="pcSearchFilter"><option value="">All Projects</option></select>
    </label>
    <label>Customer:
      <select id="pcCustomerFilter"><option value="">All Customers</option></select>
    </label>
    <label>Year:
      <select id="pcYearFilter"><option value="">All Years</option></select>
    </label>
    <label>Status:
      <select id="pcStatusFilter">
        <option value="">All Status</option>
        <option value="ongoing">Ongoing</option>
        <option value="done">Done</option>
      </select>
    </label>

    <button id="pcApplyBtn">Apply</button>
    <button id="pcAddBtn">+ Add New Project</button>
    <button id="pcCostingBtn">+ Add Costing</button>
    <div id="spinner-pc" title="Loading"></div>
  </div>

  <table id="pcTable" role="table" aria-label="Project costing table">
    <thead>
      <tr>
        <th>PROJECT NO</th>
        <th>CUSTOMER</th>
        <th>REFERENCE</th>
        <th>DESCRIPTION</th>
        <th>STATUS</th>
      </tr>
    </thead>
    <tbody id="pcBody">
      <tr><td colspan="5" class="empty-msg">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeAddProjectModal" title="Close">&times;</span>
    <iframe id="addProjectFrame" src=""></iframe>
  </div>
</div>

<!-- Costing Details Modal -->
<div id="costingModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeCostingModal" title="Close">&times;</span>
    <iframe id="costingFrame" src=""></iframe>
  </div>
</div>

<script>
const webAppProjectCosting = "https://script.google.com/macros/s/AKfycbx0gZxmtw2fUnwD95Mmf-3RoGSHOtjRZKNTTDDrCRNStaNKJ3NLyAi2m2jLUfU-P0psFg/exec";
let pcRows = [];

const el = {
  spinner: document.getElementById('spinner-pc'),
  pcBody: document.getElementById('pcBody'),
  customerFilter: document.getElementById('pcCustomerFilter'),
  yearFilter: document.getElementById('pcYearFilter'),
  statusFilter: document.getElementById('pcStatusFilter'),
  searchFilter: document.getElementById('pcSearchFilter'),
  applyBtn: document.getElementById('pcApplyBtn'),
  addBtn: document.getElementById('pcAddBtn'),
  addProjectModal: document.getElementById('addProjectModal'),
  addProjectFrame: document.getElementById('addProjectFrame'),
  closeAddProjectModal: document.getElementById('closeAddProjectModal'),
  costingBtn: document.getElementById('pcCostingBtn'),
  costingModal: document.getElementById('costingModal'),
  costingFrame: document.getElementById('costingFrame'),
  closeCostingModal: document.getElementById('closeCostingModal')
};

/* ---------- normalize Data ---------- */
function normalizeData(raw) {
  if (!Array.isArray(raw)) return [];
  if (Array.isArray(raw[0])) {
    const header = raw[0].map(h=>String(h||'').trim());
    raw = raw.slice(1).map(r=>Object.fromEntries(header.map((h,i)=>[h,r[i]])));
  }
  return raw.map(r=>({
    PROJECT_NO: r.PROJECT_NO||r.PROJECTNO||r.PROJECT||'',
    CUSTOMER: r.CUSTOMER||r.CLIENT||r.CUSTOMER_NAME||'',
    REFERENCE: r.REFERENCE||r.REF||r.PO||'',
    DESCRIPTION: r.DESCRIPTION||r.DESC||'',
    STATUS: r.STATUS||r.STATE||'',
    DATE: r.DATE||r.TRANSACTION_DATE||'',
  }));
}

/* ---------- Populate Filter Options ---------- */
function populateFilterOptions(){
  const customers = new Set();
  const years = new Set();
  const projects = new Set();

  pcRows.forEach(r=>{
    if(r.CUSTOMER) customers.add(r.CUSTOMER);
    if(r.DATE){ const y=new Date(r.DATE).getFullYear(); if(!isNaN(y)) years.add(String(y)); }
    if(r.PROJECT_NO){
      const label = r.DESCRIPTION ? `${r.PROJECT_NO} - ${r.DESCRIPTION}` : r.PROJECT_NO;
      projects.add(label);
    }
  });

  el.customerFilter.innerHTML='<option value="">All Customers</option>';
  [...customers].sort().forEach(c=>el.customerFilter.appendChild(new Option(c,c)));

  el.yearFilter.innerHTML='<option value="">All Years</option>';
  [...years].sort((a,b)=>b-a).forEach(y=>el.yearFilter.appendChild(new Option(y,y)));

  el.searchFilter.innerHTML='<option value="">All Projects</option>';
  [...projects].sort().forEach(p=>el.searchFilter.appendChild(new Option(p,p)));
}

/* ---------- Render Table ---------- */
function renderTable(){
  const cust=el.customerFilter.value.trim().toLowerCase();
  const year=el.yearFilter.value.trim();
  const status=el.statusFilter.value.trim().toLowerCase();
  const search=el.searchFilter.value.trim().toLowerCase();

  const rows=pcRows.filter(r=>{
    if(cust && r.CUSTOMER.toLowerCase()!==cust) return false;
    if(status && r.STATUS.toLowerCase()!==status) return false;
    if(year){
      const d=new Date(r.DATE);
      if(isNaN(d)||String(d.getFullYear())!==year) return false;
    }
    if(search){
      const [projNoPart] = search.split(' - ');
      if(!r.PROJECT_NO.toLowerCase().includes(projNoPart.toLowerCase())) return false;
    }
    return true;
  });

  if(!rows.length){
    el.pcBody.innerHTML='<tr><td colspan="5" class="empty-msg">No project costing rows found.</td></tr>';
    return;
  }

  el.pcBody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.PROJECT_NO||''}</td>
      <td>${r.CUSTOMER||''}</td>
      <td>${r.REFERENCE||''}</td>
      <td>${r.DESCRIPTION||''}</td>
      <td>${r.STATUS||''}</td>
    `;
    el.pcBody.appendChild(tr);
  });
}

/* ---------- Event Listeners ---------- */
el.applyBtn.addEventListener('click',renderTable);
el.customerFilter.addEventListener('change',renderTable);
el.yearFilter.addEventListener('change',renderTable);
el.statusFilter.addEventListener('change',renderTable);
el.searchFilter.addEventListener('change',renderTable);

/* ---------- Modal: Add Project ---------- */
el.addBtn.addEventListener('click',()=>{
  el.addProjectFrame.src = 'Add New Project.html';
  el.addProjectModal.style.display='block';
});
el.closeAddProjectModal.addEventListener('click',()=>{
  el.addProjectModal.style.display='none';
  el.addProjectFrame.src='';
});
window.addEventListener('click',e=>{
  if(e.target===el.addProjectModal){
    el.addProjectModal.style.display='none';
    el.addProjectFrame.src='';
  }
});

/* ---------- Modal: Costing Details ---------- */
el.costingBtn.addEventListener('click',()=>{
  el.costingFrame.src = 'Costing Details.html';
  el.costingModal.style.display = 'block';
});
el.closeCostingModal.addEventListener('click',()=>{
  el.costingModal.style.display = 'none';
  el.costingFrame.src = '';
});
window.addEventListener('click',e=>{
  if(e.target===el.costingModal){
    el.costingModal.style.display='none';
    el.costingFrame.src='';
  }
});

/* ---------- Load Data ---------- */
async function loadProjectCosting(){
  el.spinner.style.display='inline-block';
  try {
    const res = await fetch(webAppProjectCosting);
    const data = await res.json();
    pcRows = normalizeData(data);
    populateFilterOptions();
    renderTable();
  } catch(e){
    el.pcBody.innerHTML='<tr><td colspan="5" class="empty-msg">Error loading data.</td></tr>';
    console.error(e);
  } finally { el.spinner.style.display='none'; }
}
loadProjectCosting();
</script>
</body>
</html>
